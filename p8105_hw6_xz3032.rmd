---
title: "HW6 by Ximeng"
output: github_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(modelr)
library(p8105.datasets)
library(mgcv)
```

## Problem 1
```{r}
homicide_df = 
  read_csv("./data/homicide-data.csv") %>% 
  mutate(
    city_state = str_c(city, state, sep = ","),
    victim_age = as.numeric(victim_age),
    resolution = case_when(
      disposition == "Closed without arrest" ~ 0,
      disposition == "Open/No arrest"        ~ 0,
      disposition == "Closed by arrest"      ~ 1,
    )
  ) %>% 
  filter(city_state != "Tulsa_AL",
         victim_race %in% c("White", "Black")) %>% 
  select(city_state, resolution, victim_age, victim_race, victim_sex)
```

Start with one city
```{r}
baltimore_df = 
  homicide_df %>% 
  filter(city_state == "Baltimore,MD")

glm(resolution ~ victim_age + victim_race + victim_sex,
    data = baltimore_df,
    family = binomial()) %>% 
  broom::tidy() %>% 
  mutate(
    OR = exp(estimate),
    CI_lower = exp(estimate - 1.96 * std.error),
    CI_upper = exp(estimate + 1.96 * std.error)
  ) %>% 
  select(term, OR, starts_with("CI")) %>% 
  knitr::kable(digit = 3)
```

Try this across cities
```{r}
homicide_df %>%
  nest(data = -city_state) %>%
  mutate(
    models = map(.x = data, glm(resolution ~ victim_age + victim_race + victim_sex,
    data = .x,
    family = binomial())), results = map(models, broom::tidy))
```

Problem 2
```{r}
bwt_df = read_csv("data/birthweight.csv") %>%
  drop_na() %>%
  select(bwt, bhead, blength, delwt, gaweeks, babysex)

my_model = lm(bwt ~ bhead + blength + delwt, data = bwt_df) 

bwt_df %>%                            #residual vs fitted plot
  modelr::add_predictions(my_model) %>%
  modelr::add_residuals(my_model) %>%
  ggplot(aes(x = pred, y = resid)) + geom_point(alpha = 0.3) + geom_smooth()

lm_1 = lm(bwt ~ blength + gaweeks, data = bwt_df)

lm_2 = lm(bwt ~ bhead + blength + babysex + bhead*blength + bhead*babysex + blength*babysex + bhead*blength*babysex, data = bwt_df)
```

Cross validation
```{r}
cv_df = 
  crossv_mc(bwt_df,100)

cv_df =
  cv_df %>% 
  mutate(
    train = map(train, as_tibble),
    test = map(test, as_tibble))

cv_df = 
  cv_df %>%
  mutate(
    my_model = map(train, ~lm(bwt ~ bhead + blength + delwt, data = .x)),
    lm_1 = map(train, ~lm(bwt ~  blength + gaweeks, data = .x)),
    lm_2 = map(train, ~lm(bwt ~ bhead + blength + babysex + bhead*blength + bhead*babysex + blength*babysex + bhead*blength*babysex, data = .x))
  ) %>%
  mutate(
    rmse_mymodel = map2_dbl(my_model, test, ~rmse(model = .x, data = .y)),
    rmse_lm1 = map2_dbl(lm_1, test, ~rmse(model = .x, data = .y)),
    rmse_lm2 = map2_dbl(lm_2, test, ~rmse(model = .x, data = .y)))
```